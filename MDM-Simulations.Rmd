---
title: "MDM-Simulations"
author: "Simon Schwab"
date: "1 Sep 2017"
output: html_document
---

## Install R Markdown 
```{r Install R Markdown}
# install.packages("rmarkdown")
```

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Install required packages 
```{r install required packages}
# install.packages("devtools")
# install.packages("R.matlab")
# install.packages("testit")
# install.packages("testthat")
# install.packages("RColorBrewer")
# install.packages("cowplot")
# install.packages("png")
# install.packages("RcppArmadillo")
```

## Load libraries 
```{r Load required libraries, message=FALSE}
library(R.matlab)
library(testit)
library(ggplot2)
library(cowplot)
library(reshape2)
library(png)
library(grid)
```

```{r Install multdyn, message=FALSE}
# install_github("schw4b/multdyn", ref = "develop")
# library(multdyn)

# I'm using my local development branch
library(devtools)
load_all('~/workspace/multdyn')
```

## Main variables 
```{r Main variables}
N=50 # Number of simulated subjects/datasets
Nn=5 # Number of nodes
PATH_HOME = "/home/simon"
PATH = file.path(PATH_HOME, "Dropbox", "Data", "MDM")  # Project path
PATH_FIG  = file.path(PATH, 'figures') # path where figures will be stored
PATH_DATA = file.path(PATH, 'MDM-Sim', 'data') # path where time series data is
PATH_RES = file.path(PATH, 'MDM-Sim') # path where MDM data is 
```

## Loading time series of Sim1 and Sim22 
```{r Loading time series of Sim1 and Sim22}
# Downloaded from http://www.fmrib.ox.ac.uk/datasets/netsim/
S=200 # No of samples for Sim1 and Sim22

d = readMat(file.path(PATH_DATA,'sim1.mat'))
ts.sim1 = reshapeTs(d$ts,N,S)

d = readMat(file.path(PATH_DATA,'sim22.mat'))
ts.sim22 = reshapeTs(d$ts,N,S)
```


## Loading time series from 7 HRF intervention datasets 
```{r Loading time series from 7 HRF intervention datasets}
ts.int0 = readMat(file.path(PATH_DATA,'Nn5_TR2_Noise01_HRF1_Mod1_Inj0_F1.mat'))$gfy2s
ts.int1 = readMat(file.path(PATH_DATA,'Nn5_TR2_Noise01_HRF1_Mod1_Inj1_F13.mat'))$gfy2s
ts.int2 = readMat(file.path(PATH_DATA,'Nn5_TR2_Noise01_HRF1_Mod1_Inj1_F16.mat'))$gfy2s
ts.int3 = readMat(file.path(PATH_DATA,'Nn5_TR2_Noise01_HRF1_Mod1_Inj1_F20.mat'))$gfy2s
ts.int4 = readMat(file.path(PATH_DATA,'Nn5_TR2_Noise01_HRF1_Mod1_Inj1_F24.mat'))$gfy2s
ts.int5 = readMat(file.path(PATH_DATA,'Nn5_TR2_Noise01_HRF1_Mod1_Inj1_F28.mat'))$gfy2s
ts.int6 = readMat(file.path(PATH_DATA,'Nn5_TR2_Noise01_HRF1_Mod1_Inj1_F32.mat'))$gfy2s
```

## Plot timeseries of random subject
```{r Plot random timeseries, fig.height=8, fig.width=10}
t = 1:50 # interval to plot
s = sample(N,1) # random subject
vn = c("time", "node")
d=list()
d[[1]] = melt(ts.sim1[t,,s], varnames = vn)
d[[2]] = melt(ts.sim22[t,,s],varnames = vn)
d[[3]] = melt(ts.int0[t,,s], varnames = vn)
d[[4]] = melt(ts.int1[t,,s], varnames = vn)
d[[5]] = melt(ts.int2[t,,s], varnames = vn)
d[[6]] = melt(ts.int3[t,,s], varnames = vn)
d[[7]] = melt(ts.int4[t,,s], varnames = vn)
d[[8]] = melt(ts.int5[t,,s], varnames = vn)
d[[9]] = melt(ts.int6[t,,s], varnames = vn)

p=list()
str_int = c("sim1", "sim22", "int0", "int1", "int2", "int3", "int4", "int5", "int6")
for (i in 1:length(d)) {
  p[[i]] = ggplot(d[[i]], aes(x = time, y = value, group=node, color=as.factor(node))) + geom_line() +
    theme_minimal() + ggtitle(str_int[i]) + scale_color_discrete(name = "node")
}

plot_grid(plotlist = p, ncol = 2, nrow = 5, rel_widths = c(1, 1))
```

## Load time series data from single spike simulations 
```{r Loame series data from single spike simulations}
ts.ssint0 = readMat(file.path(PATH_DATA, "SingleSpike_Nn5_TR01_Noise01_HRF1_Mod1_Inj0_F1.mat"))$gfy2s
ts.ssint1 = readMat(file.path(PATH_DATA, "SingleSpike_Nn5_TR01_Noise01_HRF1_Mod1_Inj1_F13.mat"))$gfy2s
ts.ssint2 = readMat(file.path(PATH_DATA, "SingleSpike_Nn5_TR01_Noise01_HRF1_Mod1_Inj1_F16.mat"))$gfy2s
ts.ssint3 = readMat(file.path(PATH_DATA, "SingleSpike_Nn5_TR01_Noise01_HRF1_Mod1_Inj1_F20.mat"))$gfy2s
ts.ssint4 = readMat(file.path(PATH_DATA, "SingleSpike_Nn5_TR01_Noise01_HRF1_Mod1_Inj1_F24.mat"))$gfy2s
ts.ssint5 = readMat(file.path(PATH_DATA, "SingleSpike_Nn5_TR01_Noise01_HRF1_Mod1_Inj1_F28.mat"))$gfy2s
ts.ssint6 = readMat(file.path(PATH_DATA, "SingleSpike_Nn5_TR01_Noise01_HRF1_Mod1_Inj1_F32.mat"))$gfy2s
```

## Generate true network 
```{r Generate true network}
xtrue=array(NA,dim=c(5,5))
xtrue[1,2] = xtrue[2,3] = xtrue[3,4] = xtrue[4,5] = xtrue[1,5] = 1
```

## Signal SD
```{r Signal change}
SD=array(NA, dim=c(N,Nn))
for (i in 1:N) {
  SD[i,]= apply(ts.int0[,,i], 2, sd)
}
colMeans(SD)
```
As expected variability decreases from node 1 to node 4 with node 5 having higher variability.

## Pearson's correlations of the nodes 
```{r}
R=array(NA,dim=c(9,Nn)) # Sim. dataset x nodes
R[1,] = corTs(ts.sim1)[rmna(xtrue)==1]
R[2,] = corTs(ts.sim22)[rmna(xtrue)==1]
R[3,] = corTs(ts.int0)[rmna(xtrue)==1]
R[4,] = corTs(ts.int1)[rmna(xtrue)==1]
R[5,] = corTs(ts.int2)[rmna(xtrue)==1]
R[6,] = corTs(ts.int3)[rmna(xtrue)==1]
R[7,] = corTs(ts.int4)[rmna(xtrue)==1]
R[8,] = corTs(ts.int5)[rmna(xtrue)==1]
R[9,] = corTs(ts.int6)[rmna(xtrue)==1]

idx = c(1,2,3,5,4) # move connection 1->5 to last column
print(R[,idx])
```
Means across interventions 0-7
```{r}
mean(R[3:9,idx])
colMeans(R[3:9,idx])
```
## Supplementary Table S1: Time to peak of single spikes 
```{r Supplementary Table S1: Time to peak of single spikes}
TR=0.1 # This data has a TR of 0.1
STIM_ONSET=5 # 5 sec.

table.S1=array(c(
  rowMeans(apply(ts.ssint0, c(2,3), which.max) * TR - STIM_ONSET),
  rowMeans(apply(ts.ssint1, c(2,3), which.max) * TR - STIM_ONSET),
  rowMeans(apply(ts.ssint2, c(2,3), which.max) * TR - STIM_ONSET),
  rowMeans(apply(ts.ssint3, c(2,3), which.max) * TR - STIM_ONSET),
  rowMeans(apply(ts.ssint4, c(2,3), which.max) * TR - STIM_ONSET),
  rowMeans(apply(ts.ssint5, c(2,3), which.max) * TR - STIM_ONSET),
  rowMeans(apply(ts.ssint6, c(2,3), which.max) * TR - STIM_ONSET)
  ), dim=c(Nn, 7))

table.S1sd=array(c(
  apply(apply(ts.ssint0, c(2,3), which.max) * TR - STIM_ONSET, 1, sd),
  apply(apply(ts.ssint1, c(2,3), which.max) * TR - STIM_ONSET, 1, sd),
  apply(apply(ts.ssint2, c(2,3), which.max) * TR - STIM_ONSET, 1, sd),
  apply(apply(ts.ssint3, c(2,3), which.max) * TR - STIM_ONSET, 1, sd),
  apply(apply(ts.ssint4, c(2,3), which.max) * TR - STIM_ONSET, 1, sd),
  apply(apply(ts.ssint5, c(2,3), which.max) * TR - STIM_ONSET, 1, sd),
  apply(apply(ts.ssint6, c(2,3), which.max) * TR - STIM_ONSET, 1, sd)
  ), dim=c(Nn, 7))

# Mean time to peak
print(array(as.numeric(sprintf("%.2f", table.S1)), dim=c(Nn, 7)))
# SD
print(array(as.numeric(sprintf("%.2f", table.S1sd)), dim=c(Nn, 7)))
```

## Loading MDM data from Sim1 and Sim22 
```{r Loading MDM data from Sim1 and Sim22}
subj=list()
for (s in 1:N) {
  subj[[s]] = read.subject(file.path(PATH_RES,'sim1'), sprintf("Id_%03d",s), Nn)
}
mdm.sim1=mdm.group(subj)

subj=list()
for (s in 1:N) {
  subj[[s]] = read.subject(file.path(PATH_RES,'sim22'), sprintf("Id_%03d",s), Nn)
}
mdm.sim22=mdm.group(subj)
```

## Patel network analysis 
```{r Patel network analysis}
th=perm.test(ts.sim1) # get sign. thresholds
subj=list()
for (s in 1:N) {
  subj[[s]] = patel(scaleTs(ts.sim1[,,s]), TK = th$kappa, TT = th$tau) # scaling is not really necessary
}
patel.sim1=patel.group(subj)

th=perm.test(ts.sim22) # get sign. thresholds
subj=list()
for (s in 1:N) {
  subj[[s]] = patel(scaleTs(ts.sim22[,,s]), TK = th$kappa, TT = th$tau) # scaling is not really necessary
}
patel.sim22=patel.group(subj)
```

## Stats for MDM and Patel with Sim1 and Sim22 
```{r Stats for MDM and Patel with Sim1 and Sim22}
stats.mdm.sim1  = binom.nettest(mdm.sim1$tam, alter = "greater", fdr = 0.05)
stats.mdm.sim22 = binom.nettest(mdm.sim22$tam, alter = "greater", fdr = 0.05)
# patel
stats.pat.sim1  = binom.nettest(patel.sim1$net, alter = "greater", fdr = 0.05)
stats.pat.sim22 = binom.nettest(patel.sim22$net, alter = "greater", fdr = 0.05)
```

## Sensitivity and specificity of MDM vs. Patel 
```{r Sensitivity and specificity of MDM vs. Patel}
perf.mdm=list()
perf.pat=list()

perf.mdm$sim1  = perf(mdm.sim1$tam, xtrue)
perf.mdm$sim22 = perf(mdm.sim22$tam, xtrue)

perf.pat$sim1  = perf(patel.sim1$net, xtrue)
perf.pat$sim22 = perf(patel.sim22$net, xtrue)

# Median Sensitivity, specificity and accuracy for MDM and Patel's
x=array(c(apply(perf.mdm$sim22[,c(1,2,8)], 2, median),
        apply(perf.pat$sim22[,c(1,2,8)], 2, median),
        apply(perf.mdm$sim1[,c(1,2,8)], 2, median),
        apply(perf.pat$sim1[,c(1,2,8)], 2, median)), dim = c(3,4))
rownames(x) <- c("Sensitvity", "Specificity", "Accuracy")
colnames(x) <- c("MDM Sim22", "Patel Sim22", "MDM Sim1", "Patel Sim1")
print(x, digits = 2)
```

## Plot: True network and correlation matrix 
```{r True network and correlation matrix, fig.height=4, fig.width=7, message=FALSE, warning=TRUE}

comput=data.frame(nodes = as.factor(c(3,4,5,6,7,8,9,10,11,12,13,15,20,25)),
                  time= c(0.2, 0.5, 1, 2.2, 4.8, 10, 22, 48, 60+46, 3*60+44,
                          8*60+8, 38*60, 30*60*60, 58*24*60*60)^(1/3)
                  )
p5 = ggplot(data=comput, aes(x=nodes, y=time)) + geom_bar(stat="identity", fill="steelblue") +
  geom_text(aes(label=c("0.2\nsec","0.5\nsec","1\nsec","2.2\nsec","4.8\nsec","10\nsec",
                        "22\nsec","48\nsec","2\nmin","4\nmin","8\nmin","38\nmin","30\nhrs","58\ndays")), size=2.5, vjust=-0.3) +
  theme_minimal() + ylab(expression('time s'^(1/3))) + ylim(c(0, 210)) + xlab("network size")


img = readPNG(file.path(PATH_FIG, "fig-truenet-page001.png"))
g = rasterGrob(img, interpolate=T)
p1 = ggplot() + annotation_custom(g) + theme(plot.title = element_text(size=11)) + ggtitle('Simulated\n5-node network')

p2 = gplotMat(rmna(xtrue), title='5-node\nnetwork', hasColMap = F, titleTextSize = 11)
p3 = gplotMat(rmdiag(corTs(ts.sim22)), title='Dynamic\nSim22, N=50', hasColMap = F, titleTextSize = 11,
              colMapLabel = expression("Pearson\'s"~italic(r)), lim = c(0, 0.5)) + xlab("Node") + ylab("Node")
p4 = gplotMat(rmdiag(corTs(ts.sim1)), title='Stationary\nSim1, N=50', titleTextSize = 11,
              colMapLabel = expression("Pearson\'s"~italic(r)), lim = c(0, 0.5)) +  xlab("Node") + ylab("Node")

top = plot_grid(p1, p2, p3, p4, ncol=4, nrow = 1, rel_widths = c(0.6, 0.55,0.55,1), labels=c("A","","B"))
bottom= plot_grid(p5, ncol=2, labels = "C")
plot_grid(top, bottom, ncol=1)

ggsave(path = PATH_FIG, "Fig1.png")
```

## Correlations in Sim22 and Sim1
```{r}
sort(rmdiag(corTs(ts.sim22))[as.logical(xtrue)])
mean(rmdiag(corTs(ts.sim22))[as.logical(xtrue)], na.rm = T)
sort(rmdiag(corTs(ts.sim1))[as.logical(xtrue)])
mean(rmdiag(corTs(ts.sim1))[as.logical(xtrue)], na.rm = T)
```

## Plot: HRF interventions 
```{r Plot: HRF interventions, fig.height=7, fig.width=5.5, message=FALSE, warning=TRUE}
s=1:20 # Selection of subjects
ix=50:110 # start is set to stimulus onset at 5s
l=length(s)*length(ix)

# grouping variable for intervention type
int=as.factor(c(rep("0 -",l), rep("1 0.4s",l), rep("2 0.8s",l), rep("3 1.1s",l), rep("4 1.4s",l), rep("5 1.6s",l), rep("6 1.8s",l)))

img = readPNG(file.path(PATH_FIG, "fig-interventions-page001.png"))
g = rasterGrob(img, interpolate=T)
pA = ggplot() + annotation_custom(g) + theme(plot.title = element_text(size=11)) + ggtitle('HRF shape intervention')

pB=gplotMat(R[,idx], lim = c(0.1, 0.5), colMapLabel = expression("Pearson\'s"~italic(r)),
         title = "node correlations", titleTextSize = 11) +
  xlab("Node pairs") + ylab("Dataset") + 
  scale_x_discrete(limits=c("1\n2","2\n3","3\n4", "4\n5", "1\n5")) +
  scale_y_discrete(limits=c("Sim1", "Sim22", "int0", "int1", "int2",
                            "int3", "int4", "int5", "int6"))

n=1
x=cbind(ts.ssint0[ix,n,s], ts.ssint1[ix,n,s], ts.ssint2[ix,n,s],
        ts.ssint3[ix,n,s], ts.ssint4[ix,n,s], ts.ssint5[ix,n,s],
        ts.ssint6[ix,n,s])
# grouping of mean time to peak
m=c(rep(table.S1[n,1],length(ix)*length(s)), rep(table.S1[n,2],length(ix)*length(s)),
       rep(table.S1[n,3],length(ix)*length(s)), rep(table.S1[n,4],length(ix)*length(s)),
       rep(table.S1[n,5],length(ix)*length(s)), rep(table.S1[n,6],length(ix)*length(s)),
       rep(table.S1[n,7],length(ix)*length(s)))
x=melt(x)
x$int=int
x$m=m
p1=ggplot(x, aes(x=Var1*TR, y=value, group=Var2, colour=int)) + geom_line() + 
  ggtitle('node 1 lagging') + xlab("time (s)") + geom_vline(data = x, aes(xintercept = m, color=int)) +
  theme(plot.title = element_text(size=11), legend.position="none")

n=2
x=cbind(ts.ssint0[ix,n,s], ts.ssint1[ix,n,s], ts.ssint2[ix,n,s],
        ts.ssint3[ix,n,s], ts.ssint4[ix,n,s], ts.ssint5[ix,n,s],
        ts.ssint6[ix,n,s])
# grouping of mean time to peak
m=c(rep(table.S1[n,1],length(ix)*length(s)), rep(table.S1[n,2],length(ix)*length(s)),
       rep(table.S1[n,3],length(ix)*length(s)), rep(table.S1[n,4],length(ix)*length(s)),
       rep(table.S1[n,5],length(ix)*length(s)), rep(table.S1[n,6],length(ix)*length(s)),
       rep(table.S1[n,7],length(ix)*length(s)))
x=melt(x)
x$int=int
x$m=m
p2=ggplot(x, aes(x=Var1*TR, y=value, group=Var2, colour=int)) + geom_line() +
  ggtitle('node 2 rushing') + xlab("time (s)") + geom_vline(data = x, aes(xintercept = m, color=int)) +
  theme(plot.title = element_text(size=11), legend.position="none")

n=3
x=cbind(ts.ssint0[ix,n,s], ts.ssint1[ix,n,s], ts.ssint2[ix,n,s],
        ts.ssint3[ix,n,s], ts.ssint4[ix,n,s], ts.ssint5[ix,n,s],
        ts.ssint6[ix,n,s])
# grouping of mean time to peak
m=c(rep(table.S1[n,1],length(ix)*length(s)), rep(table.S1[n,2],length(ix)*length(s)),
       rep(table.S1[n,3],length(ix)*length(s)), rep(table.S1[n,4],length(ix)*length(s)),
       rep(table.S1[n,5],length(ix)*length(s)), rep(table.S1[n,6],length(ix)*length(s)),
       rep(table.S1[n,7],length(ix)*length(s)))
x=melt(x)

# visualization fix for node 3: shuffle nodes so that they intervention colors do not overlap
f=as.factor(c("0 -", "1 0.4s", "2 0.8s", "3 1.1s", "4 1.4s", "5 1.6s", "6 1.8s"))
f=f[sample(1:7)]
tmp = rep(f, each=length(ix))
x$int=tmp
x$m=m
p3=ggplot(x, aes(x=Var1*TR, y=value, group=Var2, colour=int)) + geom_line() +
  ggtitle('node 3') + xlab("time (s)") + geom_vline(data = x, aes(xintercept = m, color=int)) +
  theme(plot.title = element_text(size=11), legend.position="none")

n=4
x=cbind(ts.ssint0[ix,n,s], ts.ssint1[ix,n,s], ts.ssint2[ix,n,s],
        ts.ssint3[ix,n,s], ts.ssint4[ix,n,s], ts.ssint5[ix,n,s],
        ts.ssint6[ix,n,s])
# grouping of mean time to peak
m=c(rep(table.S1[n,1],length(ix)*length(s)), rep(table.S1[n,2],length(ix)*length(s)),
       rep(table.S1[n,3],length(ix)*length(s)), rep(table.S1[n,4],length(ix)*length(s)),
       rep(table.S1[n,5],length(ix)*length(s)), rep(table.S1[n,6],length(ix)*length(s)),
       rep(table.S1[n,7],length(ix)*length(s)))
x=melt(x)
x$int=int
x$m=m
p4=ggplot(x, aes(x=Var1*TR, y=value, group=Var2, colour=int)) + geom_line() +
  ggtitle('node 4 lagging') + xlab("time (s)") + geom_vline(data = x, aes(xintercept = m, color=int)) +
  theme(plot.title = element_text(size=11), legend.position="none")

n=5
x=cbind(ts.ssint0[ix,n,s], ts.ssint1[ix,n,s], ts.ssint2[ix,n,s],
        ts.ssint3[ix,n,s], ts.ssint4[ix,n,s], ts.ssint5[ix,n,s],
        ts.ssint6[ix,n,s])
# grouping of mean time to peak
m=c(rep(table.S1[n,1],length(ix)*length(s)), rep(table.S1[n,2],length(ix)*length(s)),
       rep(table.S1[n,3],length(ix)*length(s)), rep(table.S1[n,4],length(ix)*length(s)),
       rep(table.S1[n,5],length(ix)*length(s)), rep(table.S1[n,6],length(ix)*length(s)),
       rep(table.S1[n,7],length(ix)*length(s)))
x=melt(x)
x$int=int
x$m=m
p5=ggplot(x, aes(x=Var1*TR, y=value, group=Var2, colour=int)) + geom_line() +
  ggtitle('node 5 rushing') + xlab("time (s)") + geom_vline(data = x, aes(xintercept = m, color=int)) +
  theme(plot.title = element_text(size=11))

top=plot_grid(pA, pB, labels=c("A", "B"), ncol = 2, nrow = 1, rel_widths = c(0.8, 1))
mid=plot_grid(p1, p2, p3, labels="C", ncol = 3, nrow = 1, rel_widths = c(1, 1, 1))
bot=plot_grid(p4, p5, ncol = 2, nrow = 1, rel_widths = c(0.7, 1))

plot_grid(top, mid, bot, ncol=1, nrow=3, rel_heights = c(1, 0.8, 0.8))

ggsave(path = PATH_FIG, "Fig2.png")

```

## Plot: MDM vs. Patel 
```{r Plot: MDM vs. Patel, fig.height=7.2, fig.width=5.5, message=FALSE, warning=TRUE}

p1 = gplotMat(stats.mdm.sim22$adj, 'MDM', '%', hasColMap = F, titleTextSize = 11)
p2 = gplotMat(stats.pat.sim22$adj, 'Patel', '%', titleTextSize = 11)
p4 = gplotMat(rmna(stats.mdm.sim22$adj_fdr), 'FDR=0.05', '%', hasColMap = F, axisTextSize = 11) +
  theme(plot.title = element_text(size=11, face = "plain"))
p5 = gplotMat(rmna(stats.pat.sim22$adj_fdr), 'FDR=0.05', '%', hasColMap = F, axisTextSize = 11) +
  theme(plot.title = element_text(size=11, face = "plain"))

p7 = gplotMat(stats.mdm.sim1$adj, 'MDM', '%', hasColMap = F, titleTextSize = 11, axisTextSize = 11)
p8 = gplotMat(stats.pat.sim1$adj, 'Patel', '%', titleTextSize = 11, axisTextSize = 11)

p10 = gplotMat(rmna(stats.mdm.sim1$adj_fdr), 'FDR=0.05', '%', hasColMap = F, axisTextSize = 11) +
  theme(plot.title = element_text(size=11, face = "plain"))
p11 = gplotMat(rmna(stats.pat.sim1$adj_fdr), 'FDR=0.05', '%', hasColMap = F, axisTextSize = 11) +
  theme(plot.title = element_text(size=11, face = "plain"))

d22 = data.frame(Percent = c(perf.mdm$sim22[,1], perf.pat$sim22[,1]), Method = c(rep("MDM", N), rep("Patel", N)))
p3 = ggplot(data=d22, aes(x=Method, y=Percent, fill=NULL, colour=Method)) + geom_boxplot() +
  geom_point(shape=1, color="gray70", size=0.5, position = position_jitter(width = 0.3, height = 0.03)) +
  theme(legend.position="none", text = element_text(size=11), axis.text = element_text(size=10),
        plot.title = element_text(size=11, face = "plain"),
        panel.grid.major = element_line(colour = "gray70", linetype = "dotted"), 
        panel.grid.major.x = element_blank())  + ggtitle("Sensitivity") + scale_y_continuous(breaks=seq(0,1,0.2))

d22 = data.frame(Percent = c(perf.mdm$sim22[,2], perf.pat$sim22[,2]), Method = c(rep("MDM", N), rep("Patel", N)))
p6 = ggplot(data=d22, aes(x=Method, y=Percent, fill=NULL, colour=Method)) + geom_boxplot() +
  geom_point(shape=1, color="gray70", size=0.5, position = position_jitter(width = 0.3, height = 0.03)) +
  theme(legend.position="none", text = element_text(size=11), axis.text = element_text(size=10),
        plot.title = element_text(size=11, face = "plain"),
        panel.grid.major = element_line(colour = "gray70", linetype = "dotted"), 
        panel.grid.major.x = element_blank())  + ggtitle("Specificity") + coord_cartesian(ylim = c(0, 1)) +
  scale_y_continuous(breaks=seq(0,1,0.2))

d1 = data.frame(Percent = c(perf.mdm$sim1[,1], perf.pat$sim1[,1]), Method = c(rep("MDM", N), rep("Patel", N)))
p9 = ggplot(data=d1, aes(x=Method, y=Percent, fill=NULL, colour=Method)) + geom_boxplot() +
  geom_point(shape=1, color="gray70", size=0.5, position = position_jitter(width = 0.3, height = 0.03)) +
  theme(legend.position="none", text = element_text(size=11), axis.text = element_text(size=10),
        plot.title = element_text(size=11, face = "plain"),
        panel.grid.major = element_line(colour = "gray70", linetype = "dotted"), 
        panel.grid.major.x = element_blank())  + ggtitle("Sensitivity") + scale_y_continuous(breaks=seq(0,1,0.2))

d1 = data.frame(Percent = c(perf.mdm$sim1[,2], perf.pat$sim1[,2]), Method = c(rep("MDM", N), rep("Patel", N)))
p12 = ggplot(data=d1, aes(x=Method, y=Percent, fill=NULL, colour=Method)) + geom_boxplot() +
  geom_point(shape=1, color="gray70", size=0.5, position = position_jitter(width = 0.3, height = 0.03)) +
  theme(legend.position="none", text = element_text(size=11), axis.text = element_text(size=10),
        plot.title = element_text(size=11, face = "plain"),
        panel.grid.major = element_line(colour = "gray70", linetype = "dotted"), 
        panel.grid.major.x = element_blank()) + ggtitle("Specificity") + coord_cartesian(ylim = c(0, 1)) +
  scale_y_continuous(breaks=seq(0,1,0.2))

a = plot_grid(p1, p2, p3,    nrow=1, ncol=3, rel_widths = c(0.65, 1, 0.65), labels = c("A", "", "B"))
b = plot_grid(p4, p5, NULL, p6, nrow=1, ncol=4, rel_widths = c(1, 1, 0.5, 1))
c = plot_grid(p7, p8, p9,    nrow=1, ncol=3, rel_widths = c(0.65, 1, 0.65), labels = c("C", "", "D"))
d = plot_grid(p10, p11, NULL, p12, nrow=1, ncol=4, rel_widths = c(1, 1, 0.5, 1))
plot_grid(a, b, c, d, ncol = 1, rel_heights = c(1, 1, 1, 1))

ggsave(path = PATH_FIG, "Fig3.png")
```
## Proportions
### Dynamic data:
```{r}
# MDM
rmna(stats.mdm.sim22$adj)
summary(stats.mdm.sim22$adj[xtrue==1], na.rm = T)

# Patel
rmna(stats.pat.sim22$adj)
summary(stats.pat.sim22$adj[xtrue==1], na.rm = T)
```
### Stationary data:
```{r}
# MDM
rmna(stats.mdm.sim1$adj)
summary(stats.mdm.sim1$adj[xtrue==1], na.rm = T)

# Patel
rmna(stats.pat.sim1$adj)
summary(stats.pat.sim1$adj[xtrue==1], na.rm = T)
```


## Common network
Maximizing LPLs across datasets

```{r Common network, fig.height=2, fig.width=2}
# dim(mdm.sim22$models)
# 1. sum all LPLs across subjects
# 2. for each child node, maximize across models
idx = apply(apply(mdm.sim22$models[Nn+1,,,], c(1,2), sum), 2, which.max)

# create network matrix
M = array(0, dim=c(Nn, Nn))
for (n in 1:Nn) {
  M[mdm.sim22$models[2:Nn,idx[n],n,1], n] = 1
}

gplotMat(M, title = "Common net", hasColMap = F)
```

## Loading MDM of 7 HRF datasets 
```{r Loading MDM of 7 HRF datasets}
subj=list()
for (s in 1:N) {
  subj[[s]] = read.subject(file.path(PATH_RES,'Nn5_TR2_Noise01_HRF1_Mod1_Inj0_F1'),
                           sprintf("Id_%03d",s), Nn)
}
mdm.int0=mdm.group(subj)

subj=list()
for (s in 1:N) {
  subj[[s]] = read.subject(file.path(PATH_RES,'Nn5_TR2_Noise01_HRF1_Mod1_Inj1_F13'),
                           sprintf("Id_%03d",s), Nn)
}
mdm.int1=mdm.group(subj)

subj=list()
for (s in 1:N) {
  subj[[s]] = read.subject(file.path(PATH_RES,'Nn5_TR2_Noise01_HRF1_Mod1_Inj1_F16'),
                           sprintf("Id_%03d",s), Nn)
}
mdm.int2=mdm.group(subj)

subj=list()
for (s in 1:N) {
  subj[[s]] = read.subject(file.path(PATH_RES,'Nn5_TR2_Noise01_HRF1_Mod1_Inj1_F20'),
                           sprintf("Id_%03d",s), Nn)
}
mdm.int3=mdm.group(subj)

subj=list()
for (s in 1:N) {
  subj[[s]] = read.subject(file.path(PATH_RES,'Nn5_TR2_Noise01_HRF1_Mod1_Inj1_F24'),
                           sprintf("Id_%03d",s), Nn)
}
mdm.int4=mdm.group(subj)

subj=list()
for (s in 1:N) {
  subj[[s]] = read.subject(file.path(PATH_RES,'Nn5_TR2_Noise01_HRF1_Mod1_Inj1_F28'),
                           sprintf("Id_%03d",s), Nn)
}
mdm.int5=mdm.group(subj)

subj=list()
for (s in 1:N) {
  subj[[s]] = read.subject(file.path(PATH_RES,'Nn5_TR2_Noise01_HRF1_Mod1_Inj1_F32'),
                           sprintf("Id_%03d",s), Nn)
}
mdm.int6=mdm.group(subj)
```


## Investigate discount factor
```{r Plot: discount factor delta distribution per node, message=FALSE, warning=TRUE, fig.height=5.2, fig.width=6.5}
node=as.factor(c(rep(1,N),rep(2,N),rep(3,N),rep(4,N),rep(5,N)))
d = list()
d[[1]]=data.frame(df=c(mdm.sim1$df_),  node=node)
d[[2]]=data.frame(df=c(mdm.sim22$df_), node=node)
d[[3]]=data.frame(df=c(mdm.int0$df_),  node=node)
d[[4]]=data.frame(df=c(mdm.int1$df_),  node=node)
d[[5]]=data.frame(df=c(mdm.int2$df_),  node=node)
d[[6]]=data.frame(df=c(mdm.int3$df_),  node=node)
d[[7]]=data.frame(df=c(mdm.int4$df_),  node=node)
d[[8]]=data.frame(df=c(mdm.int5$df_),  node=node)
d[[9]]=data.frame(df=c(mdm.int6$df_),  node=node)

p = list()
for (i in 1:9) {
  p[[i]] = ggplot(d[[i]], aes(x=node, y=df)) + geom_boxplot(width=0.4) + ggtitle(str_int[i]) +
    geom_point(shape=1, color="gray70", size=0.5, position = position_jitter(width = 0.2, height = 0.0))
}
  
plot_grid(plotlist = p, ncol = 3, nrow = 3)

```

## Stats for MDM 7 HRF datasets 
```{r Stats for MDM 7 HRF datasets}
stats.mdm.int0 = binom.nettest(mdm.int0$tam, alter = "greater", fdr = 0.05)
stats.mdm.int1 = binom.nettest(mdm.int1$tam, alter = "greater", fdr = 0.05)
stats.mdm.int2 = binom.nettest(mdm.int2$tam, alter = "greater", fdr = 0.05)
stats.mdm.int3 = binom.nettest(mdm.int3$tam, alter = "greater", fdr = 0.05)
stats.mdm.int4 = binom.nettest(mdm.int4$tam, alter = "greater", fdr = 0.05)
stats.mdm.int5 = binom.nettest(mdm.int5$tam, alter = "greater", fdr = 0.05)
stats.mdm.int6 = binom.nettest(mdm.int6$tam, alter = "greater", fdr = 0.05)
```

## Sensitivity and specificity of MDM in 7 HRF datasets 
```{r Sensitivity and specificity of MDM in 7 HRF datasets}
perf.mdm$int0 = perf(mdm.int0$tam, xtrue)
perf.mdm$int1 = perf(mdm.int1$tam, xtrue)
perf.mdm$int2 = perf(mdm.int2$tam, xtrue)
perf.mdm$int3 = perf(mdm.int3$tam, xtrue)
perf.mdm$int4 = perf(mdm.int4$tam, xtrue)
perf.mdm$int5 = perf(mdm.int5$tam, xtrue)
perf.mdm$int6 = perf(mdm.int6$tam, xtrue)
```

## Create a naive network estimation as null hypothesis based on correlation and pure guessing
```{r Naive method}
R=array(NA, dim=c(Nn, Nn, N))
# correlation matrix for each data set
for (s in 1:N) {
  R[,,s]=cor(ts.int0[,,s])
}

summary(R[rmna(xtrue)==1])
summary(R[rmna(xtrue) + t(rmna(xtrue))==0])

am = R > 0.3

# threshold these correlation matrices from null network, or
# true edges are know, but not the direction
# am = array(rep(rmna(xtrue) + t(rmna(xtrue)), N), dim=c(Nn,Nn,N))

#xfalse_ = array(rep(rmna(xtrue) + t(rmna(xtrue)), N), dim=c(Nn,Nn,N)) == 0
#summary(R[xfalse_])

#R_=R > 0.2

for (s in 1:N) {
  for (i in 1:Nn) {
    for (j in 1:Nn) {
      if (i != j & i > j) {
        x=sample(1:3, 1, replace = T) # case 3 is retaining both edges (unidrected model)
        if (x == 1) {
          am[i,j,s] = 0 # remove false edge
        } else if (x == 2) {
          am[j,i,s] = 0 # remove true edge
        }
      }
    }
  }
}

perf.mdm$null = perf(am, xtrue)
```

## d-accuracy
```{r}
x = array(c(sum(mdm.sim1$tam[rmna(xtrue)==1])/(Nn*N),
            sum(mdm.sim22$tam[rmna(xtrue)==1])/(Nn*N),
            sum(patel.sim1$net[rmna(xtrue)==1])/(Nn*N),
            sum(patel.sim22$net[rmna(xtrue)==1])/(Nn*N),
            sum(am[rmna(xtrue)==1])/(Nn*N),
            sum(am[rmna(xtrue)==1])/(Nn*N)),
          dim=c(2,3))

colnames(x) <- c("MDM", "Patel", "null")
rownames(x) <- c("Sim1", "Sim22")
print(x, digits = 3)
```




## Plot: MDM sensitivity and specificity for the 7 HRF datasets 
```{r Plot: MDM sensitivity and specificity for the 7 HRF datasets, fig.height=2, fig.width=6, message=FALSE, warning=TRUE}
sel=1 # selection of perf measure, 1 sensitivity, 2 specificity
myd = data.frame(Percent = c(perf.mdm$int0[,sel], perf.mdm$int1[,sel], 
                             perf.mdm$int2[,sel], perf.mdm$int3[,sel],
                             perf.mdm$int4[,sel], perf.mdm$int5[,sel],
                             perf.mdm$int6[,sel], perf.mdm$null[,sel]),
                 Method = as.factor(c(rep("Int0", N), rep("Int1", N), rep("Int2", N),
                            rep("Int3", N), rep("Int4", N), rep("Int5", N),
                            rep("Int6", N), rep("null", N))),
                 Med = c(
                   rep(median(perf.mdm$int0[,sel]), N), rep(median(perf.mdm$int1[,sel]), N),
                   rep(median(perf.mdm$int2[,sel]), N), rep(median(perf.mdm$int3[,sel]), N),
                   rep(median(perf.mdm$int4[,sel]), N), rep(median(perf.mdm$int5[,sel]), N),
                   rep(median(perf.mdm$int6[,sel]), N), rep(median(perf.mdm$null[,sel]), N)
                   )
                 )

p1 = ggplot(myd, aes(x=Method, y=Percent)) +  geom_boxplot() +
  geom_point(shape=1, color="gray70", size=0.5, position = position_jitter(width = 0.3, height = 0.03)) +
  geom_line(aes(x=as.numeric(Method), y=Med), size=0.5, color=2) + 
  coord_cartesian(ylim = c(0, 1)) + ggtitle('Sensitivity') + xlab("Hemodynamic intervention") +
  theme(legend.position="none", panel.grid.major = element_line(colour = "gray70", linetype = "dotted"),
        panel.grid.major.x = element_blank(), text = element_text(size=11), axis.text = element_text(size=10),
        plot.title = element_text(size=11, face = "bold")) +
  scale_y_continuous(breaks=seq(0,1,0.2))

sel=2 # selection of perf measure, 1 sensitivity, 2 specificity
myd = data.frame(Percent = c(perf.mdm$int0[,sel], perf.mdm$int1[,sel], 
                             perf.mdm$int2[,sel], perf.mdm$int3[,sel],
                             perf.mdm$int4[,sel], perf.mdm$int5[,sel],
                             perf.mdm$int6[,sel], perf.mdm$null[,sel]),
                 Method = as.factor(c(rep("Int0", N), rep("Int1", N), rep("Int2", N),
                            rep("Int3", N), rep("Int4", N), rep("Int5", N),
                            rep("Int6", N), rep("null", N))),
                 Med = c(
                   rep(median(perf.mdm$int0[,sel]), N), rep(median(perf.mdm$int1[,sel]), N),
                   rep(median(perf.mdm$int2[,sel]), N), rep(median(perf.mdm$int3[,sel]), N),
                   rep(median(perf.mdm$int4[,sel]), N), rep(median(perf.mdm$int5[,sel]), N),
                   rep(median(perf.mdm$int6[,sel]), N), rep(median(perf.mdm$null[,sel]), N)
                   )
                 )

p2 = ggplot(myd, aes(x=Method, y=Percent)) +  geom_boxplot() +
  geom_point(shape=1, color="gray70", size=0.5, position = position_jitter(width = 0.3, height = 0.03)) +
  geom_line(aes(x=as.numeric(Method), y=Med), size=0.5, color=2) + 
  coord_cartesian(ylim = c(0, 1)) + ggtitle('Specificity') + xlab("Hemodynamic intervention") +
  theme(legend.position="none", panel.grid.major = element_line(colour = "gray70", linetype = "dotted"),
        panel.grid.major.x = element_blank(), text = element_text(size=11), axis.text = element_text(size=10),
        plot.title = element_text(size=11, face = "bold")) +
  scale_y_continuous(breaks=seq(0,1,0.2))

plot_grid(p1, p2, ncol=2, nrow=1)
ggsave(path = PATH_FIG, "Fig4.png")
```
## Median Sensitivity and Specificity corresponding to above figure
```{r Median Sensitivity and Specificity corresponding to abvove figure}

x = array(c(median(perf.mdm$int0[,1]), median(perf.mdm$int1[,1]), median(perf.mdm$int2[,1]), median(perf.mdm$int3[,1]), # Sensitivity
            median(perf.mdm$int4[,1]), median(perf.mdm$int5[,1]), median(perf.mdm$int6[,1]), median(perf.mdm$null[,1]),
            median(perf.mdm$int0[,2]), median(perf.mdm$int1[,2]), median(perf.mdm$int2[,2]), median(perf.mdm$int3[,2]), # Specificity
            median(perf.mdm$int4[,2]), median(perf.mdm$int5[,2]), median(perf.mdm$int6[,2]), median(perf.mdm$null[,2])
            ), dim=c(8,2))
colnames(x) <- c("Sensitvity", "Specificity")
rownames(x) <- c(str_int[3:9], "null")
print(x, digits = 2)
```

---
title: "MDM-VisMotor"
author: "Simon Schwab"
date: "30 May 2017"
output: html_document
---

## Install R Markdown 
```{r Install R Markdown}
# install.packages("rmarkdown")
```

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Install required packages 
```{r install required packages}
# install.packages("devtools")
# install.packages("testit")
# install.packages("ggplot2")
# install.packages("cowplot")
# install.packages("reshape2")
```

## Load libraries 
```{r Load required libraries, message=FALSE}
library(devtools)
library(testit)
library(ggplot2)
library(cowplot)
library(reshape2)
```

## Install and load multdyn 
```{r Install multdyn, message=FALSE}
# install_github("schw4b/multdyn", ref = "develop")
# library(multdyn)

# I'm using my local development branch
load_all('~/workspace/multdyn')
```

## Main variables 
```{r Main variables}
N=15 # Number subjects
Nn=10 # Number of nodes, does not apply to all datasets
Nn_vis=6 # Number of visual nodes
Nn_mot=4 # Number of motor nodes
Nt=230 # Volumes/no. of timepoints
Ns=5 # Sessions
PATH_HOME = "/home/simon"
PATH = file.path(PATH_HOME, 'workspace', 'MDM-nbooks') # path where figures will be stored
PATH_DATA = file.path(PATH_HOME, "Drive", "VisMotor", "TamarEugene")
PATH_RESULTS = file.path(PATH_HOME, "Drive", "VisMotor")
INFO="VisMotor"
mylabels = c("CB", "Putam", "PrimSens", "SMA",  "OccPole", "Ling", "InfLat", "PostLat",
             "OccFusif", "TempFusif")
```

## MDM network estimation Session 1
```{r MDM network estimation Session 1}
# container for all time series
# time x nodes x session x subjects
d.ts = array(NA, dim=c(Nt, Nn, Ns, N))

f1 = list.files(file.path(PATH_DATA, "r_All_Motor_L.dr"), '*.txt')
f2 = list.files(file.path(PATH_DATA, "r_All_Visual_Bi.dr"), '*.txt')
assert(length(f1) == N)
assert(length(f2) == N)

# read data
for (s in 1:N) {
  d1 = as.matrix(read.table(file.path(PATH_DATA, "r_All_Motor_L.dr", f1[s])))
  d2 = as.matrix(read.table(file.path(PATH_DATA, "r_All_Visual_Bi.dr", f2[s])))
  d = cbind(d1,d2)
  assert(ncol(d) == Nn)
  assert(nrow(d) == Nt)

  d.ts[,,1,s]=scaleTs(d)

  # calculate networks, will write txt files
  #s=subject(scaleTs(d), id=sprintf("Session1_%03d_%s", s, INFO),
  #          path = file.path(PATH_RESULTS, "MDM_VisMotor_S1"))
}
```

## MDM network estimation Session 2
```{r MDM network estimation Session 2}
f1 = list.files(file.path(PATH_DATA, "t_All_Motor_L.dr"), '*.txt')
f2 = list.files(file.path(PATH_DATA, "t_All_Visual_Bi.dr"), '*.txt')
assert(length(f1) == N)
assert(length(f2) == N)

# read data
for (s in 1:N) {
  d1 = as.matrix(read.table(file.path(PATH_DATA, "t_All_Motor_L.dr", f1[s])))
  d2 = as.matrix(read.table(file.path(PATH_DATA, "t_All_Visual_Bi.dr", f2[s])))
  d = cbind(d1,d2)
  assert(ncol(d) == Nn)
  assert(nrow(d) == Nt)

  d.ts[,,2,s]=scaleTs(d)

  # calculate networks, will write txt files
  # s=subject(scaleTs(d), id=sprintf("Session2_%03d_%s", s, INFO),
  #           path = file.path(PATH_RESULTS, "MDM_VisMotor_S2"))
}
```

## MDM network estimation Session 3
```{r MDM network estimation Session 3}
f1 = list.files(file.path(PATH_DATA, "v_All_Motor_L.dr"), '*.txt')
f2 = list.files(file.path(PATH_DATA, "v_All_Visual_Bi.dr"), '*.txt')
assert(length(f1) == N)
assert(length(f2) == N)

# read data
for (s in 1:N) {
  d1 = as.matrix(read.table(file.path(PATH_DATA, "v_All_Motor_L.dr", f1[s])))
  d2 = as.matrix(read.table(file.path(PATH_DATA, "v_All_Visual_Bi.dr", f2[s])))
  d = cbind(d1,d2)
  assert(ncol(d) == Nn)
  assert(nrow(d) == Nt)

  d.ts[,,3,s]=scaleTs(d)

  # calculate networks, will write txt files
  # s=subject(scaleTs(d), id=sprintf("Session3_%03d_%s", s, INFO),
  #           path = file.path(PATH_RESULTS, "MDM_VisMotor_S3"))
}
```

## MDM network estimation Session 4
```{r MDM network estimation Session 4}
f1 = list.files(file.path(PATH_DATA, "vt_All_Motor_L.dr"), '*.txt')
f2 = list.files(file.path(PATH_DATA, "vt_All_Visual_Bi.dr"), '*.txt')
assert(length(f1) == N)
assert(length(f2) == N)

# read data
for (s in 1:N) {
  d1 = as.matrix(read.table(file.path(PATH_DATA, "vt_All_Motor_L.dr", f1[s])))
  d2 = as.matrix(read.table(file.path(PATH_DATA, "vt_All_Visual_Bi.dr", f2[s])))
  d = cbind(d1,d2)
  assert(ncol(d) == Nn)
  assert(nrow(d) == Nt)

  d.ts[,,4,s]=scaleTs(d)

  # calculate networks, will write txt files
  # s=subject(scaleTs(d), id=sprintf("Session4_%03d_%s", s, INFO),
  #           path = file.path(PATH_RESULTS, "MDM_VisMotor_S4"))
}
```

## MDM network estimation Session 5
```{r MDM network estimation Session 5}
f1 = list.files(file.path(PATH_DATA, "vtbw_All_Motor_L.dr"), '*.txt')
f2 = list.files(file.path(PATH_DATA, "vtbw_All_Visual_Bi.dr"), '*.txt')
assert(length(f1) == N)
assert(length(f2) == N)

# read data
for (s in 1:N) {
  d1 = as.matrix(read.table(file.path(PATH_DATA, "vtbw_All_Motor_L.dr", f1[s])))
  d2 = as.matrix(read.table(file.path(PATH_DATA, "vtbw_All_Visual_Bi.dr", f2[s])))
  d = cbind(d1,d2)
  assert(ncol(d) == Nn)
  assert(nrow(d) == Nt)

  d.ts[,,5,s]=scaleTs(d)

  # calculate networks, will write txt files
  # s=subject(scaleTs(d), id=sprintf("Session5_%03d_%s", s, INFO),
  #           path = file.path(PATH_RESULTS, "MDM_VisMotor_S5"))
}
```

## Loading network data
```{r Loading network data}
# mdm = list() # container for the group data across sessions
#   
# subj=list()
# for (s in 1:N) {
#   subj[[s]] = read.subject(path = file.path(PATH_RESULTS, 'MDM_VisMotor_S1'),
#                            id = sprintf("Session1_%03d",s), nodes=Nn)
# }
# mdm$s1=mdm.group(subj)
# 
# subj=list()
# for (s in 1:N) {
#   subj[[s]] = read.subject(path = file.path(PATH_RESULTS, 'MDM_VisMotor_S2'),
#                            id = sprintf("Session2_%03d",s), nodes=Nn)
# }
# mdm$s2=mdm.group(subj)
# 
# subj=list()
# for (s in 1:N) {
#   subj[[s]] = read.subject(path = file.path(PATH_RESULTS, 'MDM_VisMotor_S3'),
#                            id = sprintf("Session3_%03d",s), nodes=Nn)
# }
# mdm$s3=mdm.group(subj)
# 
# subj=list()
# for (s in 1:N) {
#   subj[[s]] = read.subject(path = file.path(PATH_RESULTS, 'MDM_VisMotor_S4'),
#                            id = sprintf("Session4_%03d",s), nodes=Nn)
# }
# mdm$s4=mdm.group(subj)
# 
# subj=list()
# for (s in 1:N) {
#   subj[[s]] = read.subject(path = file.path(PATH_RESULTS, 'MDM_VisMotor_S5'),
#                            id = sprintf("Session5_%03d",s), nodes=Nn)
# }
# mdm$s5=mdm.group(subj)
# 
# save(mdm, file = file.path(PATH, "data", "vismotor.RData"))

load(file.path(PATH, "data", "vismotor.RData"))
```

## Plot: discount factor delta distribution per node
```{r Plot: discount factor delta distribution per node, message=FALSE, warning=TRUE, fig.height=5.2, fig.width=6}
mylim = c(0.5, 1)
p1 = ggplot(melt(mdm$s1$df_), aes(x=as.factor(Var2), y=value)) + geom_violin() + 
  geom_boxplot(width=0.4) + ggtitle("rest") + ylab("df") + xlab("node") + ylim(mylim) +
  geom_point(shape=1, color="gray70", size=2,
             position = position_jitter(width = 0.2, height = 0))
  
p2 = ggplot(melt(mdm$s2$df_), aes(x=as.factor(Var2), y=value)) + geom_violin() + 
  geom_boxplot(width=0.4) + ggtitle("motor") + ylab("df") + xlab("node") + ylim(mylim) +
  geom_point(shape=1, color="gray70", size=2,
             position = position_jitter(width = 0.2, height = 0))

p3 = ggplot(melt(mdm$s3$df_), aes(x=as.factor(Var2), y=value)) + geom_violin() + 
  geom_boxplot(width=0.4) + ggtitle("visual") + ylab("df") + xlab("node") + ylim(mylim) +
  geom_point(shape=1, color="gray70", size=2,
             position = position_jitter(width = 0.2, height = 0))

p4 = ggplot(melt(mdm$s4$df_), aes(x=as.factor(Var2), y=value)) + geom_violin() + 
  geom_boxplot(width=0.4) + ggtitle("motor/visual") + ylab("df") + xlab("node") +  ylim(mylim) +
  geom_point(shape=1, color="gray70", size=2,
             position = position_jitter(width = 0.2, height = 0))

p5 = ggplot(melt(mdm$s5$df_), aes(x=as.factor(Var2), y=value)) + geom_violin() + 
  geom_boxplot(width=0.4) + ggtitle("motor/visual II") + ylab("df") + xlab("node") +  ylim(mylim) +
  geom_point(shape=1, color="gray70", size=2,
             position = position_jitter(width = 0.2, height = 0))

plot_grid(p1, p2, p3, p4, p5, ncol = 2, nrow = 3)
```

## Correlation plot
```{r Correlation plot, fig.height=7, fig.width=6.5}
mylim = c(-0.8, 0.8)
p1 = gplotMat(rmdiag(corTs(d.ts[,,1,])), title='rest', lim=mylim,
              gradient = c("blue", "white", "red"),
              nodeLabels = mylabels, axisTextSize=8, xAngle=90,
              colMapLabel=expression("Pearson\'s"~italic(r))) + xlab("Node") + ylab("Node")

p2 = gplotMat(rmdiag(corTs(d.ts[,,2,])), title='motor', lim=mylim,
              nodeLabels = mylabels, axisTextSize=8, xAngle=90,
              gradient = c("blue", "white", "red"),
              colMapLabel=expression("Pearson\'s"~italic(r))) + xlab("Node") + ylab("Node")

p3 = gplotMat(rmdiag(corTs(d.ts[,,3,])), title='visual', lim=mylim,
              nodeLabels = mylabels, axisTextSize=8, xAngle=90,
              gradient = c("blue", "white", "red"),
              colMapLabel=expression("Pearson\'s"~italic(r))) + xlab("Node") + ylab("Node")

p4 = gplotMat(rmdiag(corTs(d.ts[,,4,])), title='motor/visual', lim=mylim,
              nodeLabels = mylabels, axisTextSize=8, xAngle=90,
              gradient = c("blue", "white", "red"),
              colMapLabel=expression("Pearson\'s"~italic(r))) + xlab("Node") + ylab("Node")

p5 = gplotMat(rmdiag(corTs(d.ts[,,5,])), title='motor/visual II', lim=mylim,
              nodeLabels = mylabels, axisTextSize=8, xAngle=90,
              gradient = c("blue", "white", "red"),
              colMapLabel=expression("Pearson\'s"~italic(r))) + xlab("Node") + ylab("Node")

plot_grid(p1, p2, p3, p4, p5, ncol = 2, nrow = 3, rel_widths = c(1, 1))
```

## Plot random timeseries
```{r Plot random timeseries, fig.height=8, fig.width=10}
t = 1:230 # interval to plot

# random sampling mice m and nodes n
nodes = 5 # no. of nodes to plot

d = melt(d.ts[t,sample(Nn,nodes),1,sample(N,1)])
p1 = ggplot(d, aes(x = Var1, y = value, group=Var2, color=as.factor(Var2))) + geom_line() +
  theme_minimal() + ggtitle("rest")

d = melt(d.ts[t,sample(Nn,nodes),2,sample(N,1)])
p2 = ggplot(d, aes(x = Var1, y = value, group=Var2, color=as.factor(Var2))) + geom_line() +
  theme_minimal() + ggtitle("motor")

d = melt(d.ts[t,sample(Nn,nodes),3,sample(N,1)])
p3 = ggplot(d, aes(x = Var1, y = value, group=Var2, color=as.factor(Var2))) + geom_line() +
  theme_minimal() + ggtitle("visual")

d = melt(d.ts[t,sample(Nn,nodes),4,sample(N,1)])
p4 = ggplot(d, aes(x = Var1, y = value, group=Var2, color=as.factor(Var2))) + geom_line() +
  theme_minimal() + ggtitle("motor/visual")

d = melt(d.ts[t,sample(Nn,nodes),5,sample(N,1)])
p5 = ggplot(d, aes(x = Var1, y = value, group=Var2, color=as.factor(Var2))) + geom_line() +
  theme_minimal() + ggtitle("motor/visual II")

plot_grid(p1, p2, p3, p4, p5, ncol = 1, nrow = 5, rel_widths = c(1, 1))
```

## Network consistency across subjects
```{r, Network consistency across subjects, fig.height=12, fig.width=6}

stats1 = binom.nettest(mdm$s1$am, alter = "greater")
stats2 = binom.nettest(mdm$s2$am, alter = "greater")
stats3 = binom.nettest(mdm$s3$am, alter = "greater")
stats4 = binom.nettest(mdm$s4$am, alter = "greater")
stats5 = binom.nettest(mdm$s5$am, alter = "greater")

p1 = gplotMat(stats1$adj, title = "rest", nodeLabels = mylabels, axisTextSize=8, xAngle=90)
p2 = gplotMat(rmna(stats1$adj_fdr), title = "binom test & FDR",
              nodeLabels = mylabels, axisTextSize=8, xAngle=90)

p3 = gplotMat(stats2$adj, title = "motor", nodeLabels = mylabels, axisTextSize=8, xAngle=90)
p4 = gplotMat(rmna(stats2$adj_fdr), title = "binom test & FDR",
              nodeLabels = mylabels, axisTextSize=8, xAngle=90)

p5 = gplotMat(stats3$adj, title = "visual", nodeLabels = mylabels, axisTextSize=8, xAngle=90)
p6 = gplotMat(rmna(stats3$adj_fdr), title = "binom test & FDR",
              nodeLabels = mylabels, axisTextSize=8, xAngle=90)

p7 = gplotMat(stats4$adj, title = "motor/visual", nodeLabels = mylabels, axisTextSize=8, xAngle=90)
p8 = gplotMat(rmna(stats4$adj_fdr), title = "binom test & FDR",
              nodeLabels = mylabels, axisTextSize=8, xAngle=90)

p9 = gplotMat(stats5$adj, title = "motor/visual II", nodeLabels = mylabels, axisTextSize=8, xAngle=90)
p10= gplotMat(rmna(stats5$adj_fdr), title = "binom test & FDR",
              nodeLabels = mylabels, axisTextSize=8, xAngle=90)

plot_grid(p1, p2, p3, p4, p5, p6, p7, p8, p9, p10, ncol = 2, nrow = 5, rel_heights = c(1,1,1))

```

## Maximize sum of LPLs across subejcts for each session
```{r Maximize sum of LPLs across subejcts for each session, fig.height=7, fig.width=6}

M = array(0, dim=c(Nn, Nn, Ns))
for (s in 1:Ns) { # session
  for (n in 1:Nn) { # node
    idx = which.max(apply(mdm[[s]]$models[Nn+1,,n,], 1, sum))
    M[mdm[[s]]$models[2:Nn,idx,n,2],n,s]=1
  }
}

p1 = gplotMat(M[,,1], title = "rest", nodeLabels = mylabels, axisTextSize=8, xAngle=90)
p2 = gplotMat(M[,,2], title = "motor", nodeLabels = mylabels, axisTextSize=8, xAngle=90)
p3 = gplotMat(M[,,3], title = "visual", nodeLabels = mylabels, axisTextSize=8, xAngle=90)
p4 = gplotMat(M[,,4], title = "motor/visual", nodeLabels = mylabels, axisTextSize=8, xAngle=90)
p5 = gplotMat(M[,,5], title = "motor/visual II", nodeLabels = mylabels, axisTextSize=8, xAngle=90)

plot_grid(p1, p2, p3, p4, p5, ncol = 2, nrow = 3, rel_heights = c(1,1,1))
```

## Common network across subjects and sessions
```{r Common network across subjects and sessions, fig.height=7, fig.width=6}
am = array(NA, dim=c(Nn, Nn, Ns, N))
am[,,1,] = mdm$s1$am
am[,,2,] = mdm$s2$am
am[,,3,] = mdm$s3$am
am[,,4,] = mdm$s4$am
am[,,5,] = mdm$s5$am
stats = binom.nettest(am, alter = "greater")

tam = array(NA, dim=c(Nn, Nn, Ns, N))
tam[,,1,] = mdm$s1$tam
tam[,,2,] = mdm$s2$tam
tam[,,3,] = mdm$s3$tam
tam[,,4,] = mdm$s4$tam
tam[,,5,] = mdm$s5$tam
tstats = binom.nettest(tam, alter = "greater")

M = array(0, dim=c(Nn, Nn))
lpl=array(NA, dim=c(Ns, 2^(Nn-1)))
for (n in 1:Nn) { # node
  for (s in 1:Ns) { # session
    lpl[s,] = apply(mdm[[s]]$models[Nn+1,,n,], 1, sum)
    
  }
  idx = which.max(apply(lpl, 2, sum))
  M[mdm[[1]]$models[2:Nn,idx,n,1],n]=1
}

p1 = gplotMat(stats$adj, title = "Common net (proportions)", nodeLabels = mylabels, axisTextSize=8,
              xAngle=90)
p2 = gplotMat(rmna(stats$adj_fdr), title = "binom test & FDR",
              nodeLabels = mylabels, axisTextSize=8, xAngle=90)

p3 = gplotMat(tstats$adj, title = "thresholded", nodeLabels = mylabels, axisTextSize=8,
              xAngle=90)
p4 = gplotMat(rmna(tstats$adj_fdr), title = "binom test & FDR",
              nodeLabels = mylabels, axisTextSize=8, xAngle=90)

p5 = gplotMat(M, title = "Common group net", nodeLabels = mylabels, axisTextSize=8, xAngle=90)

plot_grid(p1, p2, p3, p4, p5, ncol = 2, nrow = 3, rel_heights = c(1,1,1))
```

## Connectivity strength
```{r Connectivity strength}
source('~/workspace/functions MDM in R.R')

node = 9 # Occ fusiform
pars = c(5, 7, 8) # Occ pole, inf lat occ, post sup lat occ.
s = 5

df = array(NA, dim = c(N, Nn, Ns))
df[,,1]=mdm$s1$df_
df[,,2]=mdm$s2$df_
df[,,3]=mdm$s3$df_
df[,,4]=mdm$s4$df_
df[,,5]=mdm$s5$df_

# select time series of parents from best model
#pars=mdm$s1$winner[2:Nn,node,s]
#pars=pars[pars!=0]

# time x nodes x session x subjects
smt = array(NA, dim=c(Nt, length(pars)+1, Ns, N))
sCt = array(NA, dim=c(Nt, length(pars)+1, Ns, N))

for (s in 1:N) { # subjects
  for (r in 1:Ns) { # sessions
    #for (n in 1:Nn) { # child node
      
        Ft=array(1,dim=c(Nt,length(pars)+1))
        Ft[,2:ncol(Ft)]=d.ts[,pars,r,s] # selects parents
        Yt=d.ts[,node,r,s]
        
        df = getModel(mdm[[r]]$models[,,node,s], pars)[Nn+2] # df corresponding to parent model pars
        fit=dlm.lpl(Yt, t(Ft), delta = df)
        
        y = dlm_smoo(fit$mt, fit$Ct, fit$Rt, fit$nt, fit$dt)
        
        smt[, 1, r, s] = y$smt[1,]
        smt[, 2, r, s] = y$smt[2,]
        smt[, 3, r, s] = y$smt[3,]
        smt[, 4, r, s] = y$smt[4,]
     # }
  }
}
```

## Plot Connectivity strength Occ pole
```{r Plot connectivity strength 1, fig.height=8, fig.width=10}
lim=c(-2, 2)
p = 1 # select parent
s = 1:15 # select subject

p1 = ggplot(melt(smt[,p+1,1,s]), aes(x = Var1, y = value, group=Var2, color=as.factor(Var2))) + geom_line() +
  theme_minimal() + ggtitle("rest") + ylim(lim)

p2 = ggplot(melt(smt[,p+1,2,s]), aes(x = Var1, y = value, group=Var2, color=as.factor(Var2))) + geom_line() +
  theme_minimal() + ggtitle("motor") + ylim(lim)

p3 = ggplot(melt(smt[,p+1,3,s]), aes(x = Var1, y = value, group=Var2, color=as.factor(Var2))) + geom_line() +
  theme_minimal() + ggtitle("visual") + ylim(lim)

p4 = ggplot(melt(smt[,p+1,4,s]), aes(x = Var1, y = value, group=Var2, color=as.factor(Var2))) + geom_line() +
  theme_minimal() + ggtitle("visual/motor") + ylim(lim)

p5 = ggplot(melt(smt[,p+1,5,s]), aes(x = Var1, y = value, group=Var2, color=as.factor(Var2))) + geom_line() +
  theme_minimal() + ggtitle("visual/motor II") + ylim(lim)

plot_grid(p1, p2, p3, p4, p5, ncol = 1, nrow = 5, rel_widths = c(1, 1))
```


## Plot Connectivity strength inf lat occ
```{r Plot connectivity strength 2, fig.height=8, fig.width=10}
lim=c(-2, 2)
p = 2 # select parent
s = 1:15 # select subject

p1 = ggplot(melt(smt[,p+1,1,s]), aes(x = Var1, y = value, group=Var2, color=as.factor(Var2))) + geom_line() +
  theme_minimal() + ggtitle("rest") + ylim(lim)

p2 = ggplot(melt(smt[,p+1,2,s]), aes(x = Var1, y = value, group=Var2, color=as.factor(Var2))) + geom_line() +
  theme_minimal() + ggtitle("motor") + ylim(lim)

p3 = ggplot(melt(smt[,p+1,3,s]), aes(x = Var1, y = value, group=Var2, color=as.factor(Var2))) + geom_line() +
  theme_minimal() + ggtitle("visual") + ylim(lim)

p4 = ggplot(melt(smt[,p+1,4,s]), aes(x = Var1, y = value, group=Var2, color=as.factor(Var2))) + geom_line() +
  theme_minimal() + ggtitle("visual/motor") + ylim(lim)

p5 = ggplot(melt(smt[,p+1,5,s]), aes(x = Var1, y = value, group=Var2, color=as.factor(Var2))) + geom_line() +
  theme_minimal() + ggtitle("visual/motor II") + ylim(lim)

plot_grid(p1, p2, p3, p4, p5, ncol = 1, nrow = 5, rel_widths = c(1, 1))
```


## Plot Connectivity strength post sup lat occ
```{r Plot connectivity strength 3, fig.height=8, fig.width=10}
lim=c(-2, 2)
p = 3 # select parent
s = 1:15 # select subject

p1 = ggplot(melt(smt[,p+1,1,s]), aes(x = Var1, y = value, group=Var2, color=as.factor(Var2))) + geom_line() +
  theme_minimal() + ggtitle("rest") + ylim(lim)

p2 = ggplot(melt(smt[,p+1,2,s]), aes(x = Var1, y = value, group=Var2, color=as.factor(Var2))) + geom_line() +
  theme_minimal() + ggtitle("motor") + ylim(lim)

p3 = ggplot(melt(smt[,p+1,3,s]), aes(x = Var1, y = value, group=Var2, color=as.factor(Var2))) + geom_line() +
  theme_minimal() + ggtitle("visual") + ylim(lim)

p4 = ggplot(melt(smt[,p+1,4,s]), aes(x = Var1, y = value, group=Var2, color=as.factor(Var2))) + geom_line() +
  theme_minimal() + ggtitle("visual/motor") + ylim(lim)

p5 = ggplot(melt(smt[,p+1,5,s]), aes(x = Var1, y = value, group=Var2, color=as.factor(Var2))) + geom_line() +
  theme_minimal() + ggtitle("visual/motor II") + ylim(lim)

plot_grid(p1, p2, p3, p4, p5, ncol = 1, nrow = 5, rel_widths = c(1, 1))
```


## Mean/SD of the theta_t across runs
```{r Mean/Variance of the theta_t across runs, fig.height=4, fig.width=6}

#smt dims:  230   4   5  15
M=array(NA, dim=c(N, Ns, length(pars)))
for (r in 1:Ns) {
  for (p in 1:length(pars)) {
    M[,r,p] = apply(smt[,p+1,r,], 2, mean)
  }
}

SD=array(NA, dim=c(N, Ns, length(pars)))
for (r in 1:Ns) {
  for (p in 1:length(pars)) {
    SD[,r,p] = apply(smt[,p+1,r,], 2, sd)
  }
}

p1 = ggplot(melt(M[,,1]), aes(x=as.factor(Var2), y=value)) + geom_violin() + 
  geom_boxplot(width=0.4) + ggtitle("Occ Pole") + ylab("mean theta_t") + xlab("session") +
  geom_point(shape=1, color="gray70", size=2,
             position = position_jitter(width = 0.2, height = 0.0002))

p2 = ggplot(melt(M[,,2]), aes(x=as.factor(Var2), y=value)) + geom_violin() + 
  geom_boxplot(width=0.4) + ggtitle("inf lat occ") + ylab("mean theta_t") + xlab("session") +
  geom_point(shape=1, color="gray70", size=2,
             position = position_jitter(width = 0.2, height = 0.0002))

p3 = ggplot(melt(M[,,3]), aes(x=as.factor(Var2), y=value)) + geom_violin() + 
  geom_boxplot(width=0.4) + ggtitle("post sup lat occ") + ylab("mean theta_t") + xlab("session") +
  geom_point(shape=1, color="gray70", size=2,
             position = position_jitter(width = 0.2, height = 0.0002))

p4 = ggplot(melt(SD[,,1]), aes(x=as.factor(Var2), y=value)) + geom_violin() + 
  geom_boxplot(width=0.4) + ggtitle("Occ Pole") + ylab("SD theta_t") + xlab("session") +
  geom_point(shape=1, color="gray70", size=2,
             position = position_jitter(width = 0.2, height = 0.0002))

p5 = ggplot(melt(SD[,,2]), aes(x=as.factor(Var2), y=value)) + geom_violin() + 
  geom_boxplot(width=0.4) + ggtitle("inf lat occ") + ylab("SD theta_t") + xlab("session") +
  geom_point(shape=1, color="gray70", size=2,
             position = position_jitter(width = 0.2, height = 0.0002))

p6 = ggplot(melt(SD[,,3]), aes(x=as.factor(Var2), y=value)) + geom_violin() + 
  geom_boxplot(width=0.4) + ggtitle("post sup lat occ") + ylab("SD theta_t") + xlab("session") +
  geom_point(shape=1, color="gray70", size=2,
             position = position_jitter(width = 0.2, height = 0.0002))


plot_grid(p1, p2, p3, p4, p5, p6, ncol = 3, nrow = 2)
```


```{r, fig.height=10, fig.width=8}

p=list()
for (s in 1:N) {
  p[[s]] = gplotMat(mdm$s1$tam[,,s])
}

plot_grid(p[[1]], p[[2]], p[[3]], p[[4]], p[[5]], p[[6]], p[[7]], p[[8]], 
          p[[9]], p[[10]], p[[11]], p[[12]], p[[13]], p[[14]], p[[15]],
          ncol = 3, nrow = 5)

```

